[다음 동영상](https://www.youtube.com/watch?v=XyuqoWUCdGA)을 보고 정리한 내용입니다. 

### 카프카의 기본적인 구조 
- 카프카는 토픽에 메세지를 발행 및 구독하는 구조 
- 토픽은 병렬 처리를 위해 파티션 단위로 구성 
- 파티션은 안정성을 위해 레플리카로 복제 구성

레플리카는 리더 레플리카와 팔로우 레플리카로 나뉘어 서로 다른 브로커로 퍼져 위치하며 다음과 같이 표현할 수 있습니다.
![[스크린샷 2024-04-01 오전 8.13.41.png]]

위 그림은 배달 이라는 토픽이 세 개의 파티션과 복제 인수 3으로 구성된 예시입니다. 
동일한 파티션 레플리카들이 서로 다른 브로커에 흩어져 구성되 있는걸 확인할 수 있습니다.

Q. 파티션과 레플리카의 차이는?
- **파티션**: 데이터를 병렬로 처리하기 위해 토픽을 분할하는 단위입니다. 처리량 증가와 확장성을 위해 사용됩니다.
	카프카에서 메세지가 파티션에 할당되는 방식은 여러 가지가 존재하며 프로듀서의 설정에 따라 달라집니다. 별도의 메세지 키를 제공하지 않는 경우 카프카 프로듀서는 라운드 로빈 방식으로 메세지를 파티션에 분산합니다. 
	만약 메세지 키를 사용한다면 카프카는 키에 대한 해시 값을 기반으로 메세지를 특정 파티션에 할당합니다.
- **레플리카**: 데이터의 내구성과 가용성을 보장하기 위해 파티션의 복사본을 유지하는 것입니다. 내결함성과 데이터 안정성을 위해 사용됩니다.
Q. 리더 파티션은 다른 브로커에 위치해야 되는가?
	리더 파티션은 다른 브로커에 위치하는게 좋습니다. 이는 각 파티션에 대한 읽기 및 쓰기 작업의 부하를 분산시키고, 하나의 브로커에 장애가 발생했을 때 토픽의 가용성을 유지하기 위함입니다. 그러나 실제로 모든 리더 파티션이 항상 각기 다른 브로커에 위치하는 것은 클러스터의 상태, 브로커의 수, 파티션의 할당 방식 등에 따라 달라질 수 있습니다.
	카프카는 레플리카의 배치와 리더 선출을 자동으로 관리합니다. 카프카 클러스터가 잘 설계되고 충분한 수의 브로커가 있다면, 카르카는 가능한 한 각 리더 파티션을 서로 다른 브로커에 고르게 분산시키려 합니다.
	만약 브로커가 3개라면 각 브로커가 리더 파티션과 레플리카를 균등하게 갖고 있겠지만, 브로커가 많다면 더 많은 분산과 리더 파티션의 균등한 배치가 가능해집니다. 

### 상태 기반 시스템 
발행되는 메세지는 브로커의 파일 시스템에 저장됩니다. 
- 토픽 파티션 별 로그 세그먼트에 메세지가 저장

즉, "브로커가 특정 토픽 파티션의 메세지를 저장하고 있다"는 말은 "브로커가 토픽 파티션의 레플리카를 가지고 있다"고 말할 수 있고, 또 이 말은 "브로커가 토픽 파티션의 상태를 가지고 있다"고 이야기 할 수 있습니다.

하지만 카프카는 상태를 자동으로 옮기지 않습니다.
토픽 파티션의 레플리카는 운영자가 지정한 브로커에 위치하며 해당 브로커의 이슈가 발생하더라도 브로커 자체적으로 해당 레플리카를 옮기지 않습니다.
***운영자가 레플리카, 즉 상태를 직접 관리해주어야 합니다.***

### 클라우드 환경의 특징 

### 우아한 형제들의 카프카
해당 기업의 카프카 클러스터 규모는 다음과 같습니다. 
- 카프카 클러스터 27개
- 브로커 162대
- 파티션 약 24,000개 
- 초당 평균 50만건, 최대 140만건 메세지 유입 

메세지 플랫폼, 라이더 배차 시스템, 데이터 플랫폼 등 다양한 서비스에서 카프카가 사용되고 있습니다.

카프카의 규모가 커지고 인스턴스의 수가 늘어날 수록 이슈의 발생 빈도는 증가할 것입니다. 
클라우드 환경은 이러한 이슈 빈도를 더 높일 수 있으며, 이를 추적 관리 하기는 매우 어렵습니다.

Q. 클라우드 환경에서 점점 늘어나는 카프카 클러스터를 어떻게 하면 안정적이고 효율적으로 운영할 수 있을까?
	우아한 형제들은 초기 단일 주키퍼에 의존하였습니다. 하지만 주키퍼에 등록되는 카프카 클러스터가 증가함에 따라 주키퍼 인스턴스에 이슈가 생기면 전체 서비스가 마비되었습니다.
![[스크린샷 2024-04-01 오전 8.31.23.png]]

#### 격리된 클러스터를 구성하자 
주키퍼 : 카프카 = 1 : 1 구조로 변경하여 제공하였습니다. 
서비스 별 격리된 환경으로 구성하였습니다.
![[스크린샷 2024-04-01 오전 8.33.07.png]]
